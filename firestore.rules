rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Barbeiros: Perfis são públicos para agendamento, mas apenas o dono pode editar.
    match /barbers/{barberId} {
      // Qualquer um pode ler um perfil de barbeiro se estiver completo.
      allow get: if resource.data.profileComplete == true;
      // Usuários logados podem listar os barbeiros para a página de agendamento.
      allow list: if request.auth != null;
      // O barbeiro pode ler e escrever em seu próprio perfil a qualquer momento.
      allow read, write: if isOwner(barberId);

      // Agendamentos: A agenda é do barbeiro, mas clientes podem criar seus próprios agendamentos.
      match /appointments/{appointmentId} {
        // O barbeiro pode ler e gerenciar todos os seus agendamentos.
        allow read, update, delete: if isOwner(barberId);
        // Um cliente só pode criar um agendamento para si mesmo.
        allow create: if isOwner(request.resource.data.clientUid);
      }
    }
    
    // Clientes: Perfis são totalmente privados.
    match /clients/{clientId} {
      allow read, write: if isOwner(clientId);
    }
    
    // Regra Global para Collection Group: Permite que um cliente leia seus agendamentos em qualquer agenda.
    // Esta regra é essencial para a tela "Meus Agendamentos" do cliente funcionar.
    match /{path=**}/appointments/{appointmentId} {
        allow read: if isOwner(resource.data.clientUid);
    }
  }
}
